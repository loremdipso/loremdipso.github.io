<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Lithe 7 - Apples to Apples</title><meta content="Continued exploration of Lithe, an attempt at re-writing the Svelte compiler in Rust" name=description><link href="/style.css?h=113f377b3ae52303efd1" integrity="sha256-ET83ezrlIwPv0VEg5Um8fx4qGJsUhKwPaUTyshbShXA=" crossorigin rel=stylesheet><link href="/post.css?h=618e029f323073604e10" integrity="sha256-YY4CnzIwc2BOEGNHgWXNaGjZyO9H+TjljQ/oWRSHwEg=" crossorigin rel=stylesheet><script src="/js/post-scroll.js?h=edfc3a547fcea064d0ad" async crossorigin></script><body><header class="app-header slide-in-from-top"><nav><a href=/>About</a><a class=active href=/posts/>Posts</a><a href=/minis/>Minis</a><a href=/projects/>Projects</a></nav><div class=socials><a rel="noopener me" href=https://www.linkedin.com/in/loremdipso/ target=_blank title=Linkedin> <span class=inline-svg> <svg viewbox="0 0 448 512" class=icon fill=#44bddc height=1em stroke=currentColor stroke-width=0 width=1em xmlns=http://www.w3.org/2000/svg><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg> </span> </a><a rel="noopener me" href=https://github.com/loremdipso target=_blank title=Github> <span class=inline-svg> <svg viewbox="0 0 496 512" class=icon fill=#44bddc height=1em stroke=currentColor stroke-width=0 width=1em xmlns=http://www.w3.org/2000/svg><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg> </span> </a></div></header><div class=content-wrapper><div class=content><div class=progress-bar></div><main><article><header class=post-header><h1>Lithe 7 - Apples to Apples</h1><hr><div class=post-subheader><div class=post-metadata>Jan 15, 2022 · 3 minute read</div><div class=tags><a class=tag href=https://loremdipso.com/tags/lithe/> <span class=inline-svg> <svg class="feather feather-tag meta-icon" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1=7 x2=7 y1=7 y2=7></line></svg> </span> lithe </a><a class=tag href=https://loremdipso.com/tags/performance/> <span class=inline-svg> <svg class="feather feather-tag meta-icon" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1=7 x2=7 y1=7 y2=7></line></svg> </span> performance </a><a class=tag href=https://loremdipso.com/tags/svelte/> <span class=inline-svg> <svg class="feather feather-tag meta-icon" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1=7 x2=7 y1=7 y2=7></line></svg> </span> svelte </a></div></div><a href="https://github.com/loremdipso/loremdipso.github.io/issues/new?title=Issue with lithe-7&body=I found an issue on page 'Lithe 7 - Apples to Apples'" class=feedback target=#>Found a mistake? Let me know!</a></header><div class=post-contents><div class=sidenav><aside class=toc-wrapper><div class=toc-title>Contents</div><ul><li><a href=#confession-time>Confession Time</a><li><a href=#disambiguation>Disambiguation</a><li><a href=#the-specifics>The Specifics</a><li><a href=#the-methodology>The Methodology</a><li><a href=#the-results>The Results</a></ul></aside></div><h2 id=confession-time><a aria-label="Anchor link for: confession-time" class=zola-anchor href=#confession-time>Confession Time</a></h2><p>My performance testing methodology so far has been extremely flawed. It serves mostly as an indicator for how rigorous performance testing might go when I eventually get around to it. Which I think is reasonable, but it doesn't have to be quite so unfair to Svelte. Svelte is doing quite a lot more than Lithe, so I really shouldn't be comparing them side by side. It'd be good to re-run some earlier tests, but with the JavaScript equivalent of what Lithe is doing. Which, let's be honest, is mostly just parsing the HTML into an AST.<h2 id=disambiguation><a aria-label="Anchor link for: disambiguation" class=zola-anchor href=#disambiguation>Disambiguation</a></h2><p>It's good to have names for things, so let's call this super-basic JavaScript version <a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Tongue-in-cheek target=_blank>LitheJS</a>.<h2 id=the-specifics><a aria-label="Anchor link for: the-specifics" class=zola-anchor href=#the-specifics>The Specifics</a></h2><p>Lithe has been using the <a rel="noopener nofollow noreferrer" href=https://crates.io/crates/html_parser target=_blank>html_parser crate</a>. For LitheJS I'll use the very popular <a rel="noopener nofollow noreferrer" href=https://www.npmjs.com/package/node-html-parser target=_blank>Fast HTML Parser</a>. It's got 2.3M downloads a week, and it's even got Fast in the name. If anything's going to give Lithe a run for its money it's going to be that.<h2 id=the-methodology><a aria-label="Anchor link for: the-methodology" class=zola-anchor href=#the-methodology>The Methodology</a></h2><p>We'll do the same as before: super simple HTML files, just N <code>&lt;span>Hello world!&lt;/span></code> elements. No nesting, no scripting, and I'm not even going to ask LitheJS to produce any output or perform any transformations. I just want to know: how long does it take to parse the HTML into an AST, and how does that compare with Lithe?<p>My thought is if Lithe can still beat out LitheJS, even after giving it all these advantages, then we're on the right track.<p>Notably, though, I'm not going to bother improving any of the rest of my methodology just yet. I'm not averaging multiple runs, I'm not going to nest HTML elements, I'm measuring performance directly in Node, all results are in ms, etc.<h2 id=the-results><a aria-label="Anchor link for: the-results" class=zola-anchor href=#the-results>The Results</a></h2><table><thead><tr><th>Number of <code>span</code>s<th>Svelte<th>Lithe - native<th>Lithe - WASM<th>LitheJS<tbody><tr><td>1<td>7ms<td>3ms<td>1ms<td>1ms<tr><td>10<td>10ms<td>1ms<td>1ms<td>1ms<tr><td>100<td>108ms<td>4ms<td>3ms<td>1ms<tr><td>1000<td>348ms<td>6ms<td>9ms<td>3ms<tr><td>10,000<td>N/A (<a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Stack_buffer_overflow target=_blank>SO</a>)<td>53ms<td>81ms<td>125ms</table><p>Wow, that Fast HTML Parser really is fast! At least until you get into really big files. But let's dig into that a bit more. Right now I'm just parsing these file contents and throwing away the result:<pre class=language-ts data-lang=ts style=color:#cccece;background-color:#2b2c2f><code class=language-ts data-lang=ts><span style=color:#c594c5>function </span><span style=color:#69c>simple_html_parser</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>contents</span><span style=color:#5fb3b3>: </span><span>String</span><span style=color:#5fb3b3>) {
</span><span>	</span><span style=color:#c594c5>const </span><span>root </span><span style=color:#5fb3b3>= </span><span style=color:#69c>parse</span><span>(contents)</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span></code></pre><p>I haven't read the source, but I suppose it's possible that Fast HTML Parser is being super <a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Lazy_evaluation target=_blank>lazy</a> and not fully parsing the HTML string it was given until it has to. Let's make it work a little harder:<pre class=language-ts data-lang=ts style=color:#cccece;background-color:#2b2c2f><code class=language-ts data-lang=ts><span style=color:#c594c5>function </span><span style=color:#69c>simple_html_parser</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>contents</span><span style=color:#5fb3b3>: </span><span>String</span><span style=color:#5fb3b3>) {
</span><span>	</span><span style=color:#c594c5>const </span><span>root </span><span style=color:#5fb3b3>= </span><span style=color:#69c>parse</span><span>(contents)</span><span style=color:#5fb3b3>;
</span><span>	</span><span style=color:#c594c5>const </span><span>result </span><span style=color:#5fb3b3>= </span><span>contents</span><span style=color:#5fb3b3>.</span><span style=color:#69c>toString</span><span>()</span><span style=color:#5fb3b3>;
</span><span>	</span><span style=color:#c594c5>return </span><span>result</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span></code></pre><p>Let's re-run those last couple of tests. I included a range here since the results were highly variable:<table><thead><tr><th>Number of <code>span</code>s<th>LitheJS<tbody><tr><td>1000<td>8ms-18ms<tr><td>10,000<td>58ms-140ms</table><p>Alright, so it's a little bit slower, but not by that much. I'm guessing there's no lazy evaluation going on here: Fast HTML Parser is just fast. For fun I added timing inside the native version of Lithe just around the HTML parsing bit. And if we get rid of the <code>toString()</code> call in our <code>simple_html_parser</code> we can compare just the DOM parsing.<table><thead><tr><th>Number of <code>span</code>s<th>LitheJS (just HTML parsing)<th>Lithe - native (just HTML parsing)<tbody><tr><td>100<td>1ms<td>0ms<tr><td>1000<td>4ms-13ms<td>1ms<tr><td>10,000<td>41ms-142ms<td>18ms-27ms</table><p>And with that we're finally comparing like with like. And the results look how I'd expect. If we take out the FFI overhead and only parse the HTML then the Rust version is looking to be a bit faster, especially for larger files.</div></article><hr><div class=suggested-post-links><h3>Suggested reading</h3><a class=previous href=/posts/lithe-6> Previously: <b>Lithe 6: What about WASM?</b> </a><a class=next href=/posts/secret-santa-saga> Up next: <b>Secret Santa: a Saga</b> </a></div></main></div><footer class="app-footer fade-in"><p>© 2025  Michael Adams  <a href=/rss.xml target=_blank title=rss> <span class=inline-svg> <svg class="feather feather-rss" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </span> </a></footer></div>