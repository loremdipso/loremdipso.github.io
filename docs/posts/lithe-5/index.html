<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Lithe 5: Optimize for the minifier</title><meta content="Continued exploration of Lithe, an attempt at re-writing the Svelte compiler in Rust" name=description><link href="/style.css?h=113f377b3ae52303efd1" integrity="sha256-ET83ezrlIwPv0VEg5Um8fx4qGJsUhKwPaUTyshbShXA=" crossorigin rel=stylesheet><link href="/post.css?h=618e029f323073604e10" integrity="sha256-YY4CnzIwc2BOEGNHgWXNaGjZyO9H+TjljQ/oWRSHwEg=" crossorigin rel=stylesheet><script src="/js/post-scroll.js?h=edfc3a547fcea064d0ad" async crossorigin></script><body><header class="app-header slide-in-from-top"><nav><a href=/>About</a><a class=active href=/posts/>Posts</a><a href=/minis/>Minis</a><a href=/projects/>Projects</a></nav><div class=socials><a rel="noopener me" href=https://www.linkedin.com/in/loremdipso/ target=_blank title=Linkedin> <span class=inline-svg> <svg viewbox="0 0 448 512" class=icon fill=#44bddc height=1em stroke=currentColor stroke-width=0 width=1em xmlns=http://www.w3.org/2000/svg><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg> </span> </a><a rel="noopener me" href=https://github.com/loremdipso target=_blank title=Github> <span class=inline-svg> <svg viewbox="0 0 496 512" class=icon fill=#44bddc height=1em stroke=currentColor stroke-width=0 width=1em xmlns=http://www.w3.org/2000/svg><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg> </span> </a></div></header><div class=content-wrapper><div class=content><div class=progress-bar></div><main><article><header class=post-header><h1>Lithe 5: Optimize for the minifier</h1><hr><div class=post-subheader><div class=post-metadata>Jan 08, 2022 · 3 minute read</div><div class=tags><a class=tag href=https://loremdipso.com/tags/devlog/> <span class=inline-svg> <svg class="feather feather-tag meta-icon" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1=7 x2=7 y1=7 y2=7></line></svg> </span> devlog </a><a class=tag href=https://loremdipso.com/tags/lithe/> <span class=inline-svg> <svg class="feather feather-tag meta-icon" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1=7 x2=7 y1=7 y2=7></line></svg> </span> lithe </a><a class=tag href=https://loremdipso.com/tags/performance/> <span class=inline-svg> <svg class="feather feather-tag meta-icon" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1=7 x2=7 y1=7 y2=7></line></svg> </span> performance </a><a class=tag href=https://loremdipso.com/tags/svelte/> <span class=inline-svg> <svg class="feather feather-tag meta-icon" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1=7 x2=7 y1=7 y2=7></line></svg> </span> svelte </a></div></div><a href="https://github.com/loremdipso/loremdipso.github.io/issues/new?title=Issue with lithe-5&body=I found an issue on page 'Lithe 5: Optimize for the minifier'" class=feedback target=#>Found a mistake? Let me know!</a></header><div class=post-contents><p><a rel="noopener nofollow noreferrer" href=https://github.com/halfnelson target=_blank>halfnelson</a> did a lovely <a rel="noopener nofollow noreferrer" href=https://github.com/halfnelson/svelte-it-will-scale/blob/master/README.md target=_blank>investigation of how large Svelte projects scale</a>. I'm not looking to rehash that per se, but I am interested in how well the current Svelte compiler's output gets minified.<p>For this investigation I'll be pulling as many <code>.svelte</code> files as I can. Let's use the <a rel="noopener nofollow noreferrer" href=https://copilot.github.com/ target=_blank>Autopilot</a> strategy and pull from GitHub repos with permissive enough licenses.<p>Even doing this was a bit of a project. I figured this might come up again, so I made the code clean enough that I wasn't embarrassed to release it. You can see what I came up with at the <a rel="noopener nofollow noreferrer" href=https://github.com/loremdipso/github_batch_download target=_blank>github repo</a>. I used Rust with the lovely <a rel="noopener nofollow noreferrer" href=https://docs.rs/octocrab/latest/octocrab/ target=_blank>octocrab</a> crate to handle the Github API, <a rel="noopener nofollow noreferrer" href=https://docs.rs/git2/latest/git2/ target=_blank>git2</a> to handle downloading the repositories, and a little bit of <a rel="noopener nofollow noreferrer" href=https://github.com/tokio-rs/tokio target=_blank>tokio</a> for async and multi-threading. I'm very happy with the result, though I did run into rate-limiting for the GitHub API fairly quickly even with a <a rel="noopener nofollow noreferrer" href=https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token target=_blank>personal access token</a>.<p>Even so, I was able to come out of that with 220 repos without much trouble, from which I extracted 20MB of raw <code>.svelte</code> files. Once I removed the empties and the duplicates I was left with a respectable <code>18MB</code> worth of files. I ran those files through the svelte compiler, skipping any that wouldn't compile. I didn't expect to run this too often, so I ended up using ruby to call a shell script that told node to compile a particular file with some options, which I ran over every file twice: once with minification and once without. While I ended up with a workflow that took several minutes to run it was the fastest for me to write.<p>After a cuppa I had this:<table><thead><tr><th>Type<th>Total size (KB)<tbody><tr><td>raw <code>.svelte</code> files<td>18420<tr><td>compiled<td>23188<tr><td>minified<td>15764<tr><td>gzipped<td>10836</table><p>Very interestingly there were two files whose minified size was actually slightly larger than the original. This makes me think I could find a better minifier than <a rel="noopener nofollow noreferrer" href=https://www.npmjs.com/package/minify target=_blank>minify</a>. Even after playing with the available options, going so far as to enable some unsafe operations, I still couldn't get that number down. I might try another minifier entirely (<a rel="noopener nofollow noreferrer" href=https://www.npmjs.com/package/node-minify target=_blank>node-minify</a> looks cool), but for now I'll keep what I've got.<p>I think that's enough for now. Once I get a compiler going I can use this to measure just how well my output fairs against Svelte's, both raw and after minification. I believe there's some room for improvement if we try and output code that's easy for the minifier to minify. For example, I've noticed the Svelte compiler outputs something sort of like this for detaching a component (heavily edited for simplicity):<pre class=language-js data-lang=js style=color:#cccece;background-color:#2b2c2f><code class=language-js data-lang=js><span style=color:#c594c5>import </span><span style=color:#5fb3b3>{ </span><span>detach </span><span style=color:#5fb3b3>} </span><span style=color:#c594c5>from </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>./svelte</span><span style=color:#5fb3b3>";
</span><span>
</span><span style=color:#c594c5>let </span><span>a</span><span style=color:#5fb3b3>;
</span><span style=color:#c594c5>let </span><span>b</span><span style=color:#5fb3b3>;
</span><span style=color:#c594c5>let </span><span>c</span><span style=color:#5fb3b3>;
</span><span>
</span><span style=color:#c594c5>function </span><span style=color:#69c>fn</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>do_detach</span><span style=color:#5fb3b3>) {
</span><span>	</span><span style=color:#c594c5>if </span><span>(do_detach) </span><span style=color:#69c>detach</span><span>(a)</span><span style=color:#5fb3b3>;
</span><span>	</span><span style=color:#c594c5>if </span><span>(do_detach) </span><span style=color:#69c>detach</span><span>(b)</span><span style=color:#5fb3b3>;
</span><span>	</span><span style=color:#c594c5>if </span><span>(do_detach) </span><span style=color:#69c>detach</span><span>(c)</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span></code></pre><p>Which get minified to:<pre class=language-js data-lang=js style=color:#cccece;background-color:#2b2c2f><code class=language-js data-lang=js><span style=color:#c594c5>import </span><span style=color:#5fb3b3>{ </span><span>detach </span><span style=color:#5fb3b3>} </span><span style=color:#c594c5>from </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>./svelte</span><span style=color:#5fb3b3>";
</span><span style=color:#c594c5>let </span><span>a</span><span style=color:#5fb3b3>, </span><span>b</span><span style=color:#5fb3b3>, </span><span>c</span><span style=color:#5fb3b3>;
</span><span style=color:#c594c5>function </span><span style=color:#69c>fn</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>t</span><span style=color:#5fb3b3>) {
</span><span>	t </span><span style=color:#5fb3b3>&& </span><span style=color:#69c>detach</span><span>(a)</span><span style=color:#5fb3b3>, </span><span>t </span><span style=color:#5fb3b3>&& </span><span style=color:#69c>detach</span><span>(b)</span><span style=color:#5fb3b3>, </span><span>t </span><span style=color:#5fb3b3>&& </span><span style=color:#69c>detach</span><span>(c)</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span></code></pre><p>If, instead, the source was:<pre class=language-js data-lang=js style=color:#cccece;background-color:#2b2c2f><code class=language-js data-lang=js><span style=color:#c594c5>import </span><span style=color:#5fb3b3>{ </span><span>detach </span><span style=color:#5fb3b3>} </span><span style=color:#c594c5>from </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>./svelte</span><span style=color:#5fb3b3>";
</span><span>
</span><span style=color:#c594c5>let </span><span>a</span><span style=color:#5fb3b3>;
</span><span style=color:#c594c5>let </span><span>b</span><span style=color:#5fb3b3>;
</span><span style=color:#c594c5>let </span><span>c</span><span style=color:#5fb3b3>;
</span><span>
</span><span style=color:#c594c5>function </span><span style=color:#69c>fn</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>do_detach</span><span style=color:#5fb3b3>) {
</span><span>	</span><span style=color:#c594c5>if </span><span>(do_detach) </span><span style=color:#5fb3b3>{
</span><span>		</span><span style=color:#69c>detach</span><span>(a)</span><span style=color:#5fb3b3>;
</span><span>		</span><span style=color:#69c>detach</span><span>(b)</span><span style=color:#5fb3b3>;
</span><span>		</span><span style=color:#69c>detach</span><span>(c)</span><span style=color:#5fb3b3>;
</span><span>	</span><span style=color:#5fb3b3>}
</span><span style=color:#5fb3b3>}
</span></code></pre><p>Which, in this example at least, is functionally equivalent. I haven't dug into Svelte enough to know if this is always going to be a safe transformation. In any case, this can be minified to:<pre class=language-js data-lang=js style=color:#cccece;background-color:#2b2c2f><code class=language-js data-lang=js><span style=color:#c594c5>import </span><span style=color:#5fb3b3>{ </span><span>detach </span><span style=color:#5fb3b3>} </span><span style=color:#c594c5>from </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>./svelte</span><span style=color:#5fb3b3>";
</span><span style=color:#c594c5>let </span><span>a</span><span style=color:#5fb3b3>, </span><span>b</span><span style=color:#5fb3b3>, </span><span>c</span><span style=color:#5fb3b3>;
</span><span style=color:#c594c5>function </span><span style=color:#69c>fn</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>t</span><span style=color:#5fb3b3>) {
</span><span>	t </span><span style=color:#5fb3b3>&& </span><span>(</span><span style=color:#69c>detach</span><span>(a)</span><span style=color:#5fb3b3>, </span><span style=color:#69c>detach</span><span>(b)</span><span style=color:#5fb3b3>, </span><span style=color:#69c>detach</span><span>(c))</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span></code></pre><p>A whole 4 characters saved! I know, I know, it doesn't seem like much, but that's basically free and is a function of how many variables your svelte program has. One last consideration is aliasing. We could, for example, imagine a minifier smart enough to output this:<pre class=language-js data-lang=js style=color:#cccece;background-color:#2b2c2f><code class=language-js data-lang=js><span style=color:#c594c5>import </span><span style=color:#5fb3b3>{ </span><span>detach </span><span style=color:#c594c5>as </span><span>d </span><span style=color:#5fb3b3>} </span><span style=color:#c594c5>from </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>./svelte</span><span style=color:#5fb3b3>";
</span><span style=color:#c594c5>let </span><span>a</span><span style=color:#5fb3b3>, </span><span>b</span><span style=color:#5fb3b3>, </span><span>c</span><span style=color:#5fb3b3>;
</span><span style=color:#c594c5>function </span><span style=color:#69c>fn</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>t</span><span style=color:#5fb3b3>) {
</span><span>	t </span><span style=color:#5fb3b3>&& </span><span>(</span><span style=color:#69c>d</span><span>(a)</span><span style=color:#5fb3b3>, </span><span style=color:#69c>d</span><span>(b)</span><span style=color:#5fb3b3>, </span><span style=color:#69c>d</span><span>(c))</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span></code></pre><p>We could also eschew aliasing and just have a separate svelte library that only has these minified functions to avoid the "as x" bit:<pre class=language-js data-lang=js style=color:#cccece;background-color:#2b2c2f><code class=language-js data-lang=js><span style=color:#c594c5>import </span><span style=color:#5fb3b3>{ </span><span>d </span><span style=color:#5fb3b3>} </span><span style=color:#c594c5>from </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>./svelte-mini</span><span style=color:#5fb3b3>";
</span><span style=color:#c594c5>let </span><span>a</span><span style=color:#5fb3b3>, </span><span>b</span><span style=color:#5fb3b3>, </span><span>c</span><span style=color:#5fb3b3>;
</span><span style=color:#c594c5>function </span><span style=color:#69c>fn</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>t</span><span style=color:#5fb3b3>) {
</span><span>	t </span><span style=color:#5fb3b3>&& </span><span>(</span><span style=color:#69c>d</span><span>(a)</span><span style=color:#5fb3b3>, </span><span style=color:#69c>d</span><span>(b)</span><span style=color:#5fb3b3>, </span><span style=color:#69c>d</span><span>(c))</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span></code></pre><p>The downside of some of these optimizations, of course, is that it becomes harder and harder to debug in production. But if we're already at the point of minifying I say it's <a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/No_Holds_Barred_(1989_film) target=_blank>no holds barred</a>.<details><summary>Extra considerations</summary> <p>While minimizing the compiled svelte files seems like an obvious win it may not actually amount to much given how good gzip is. We'll need to run out output through gzip to know if we'll actually be sending fewer bytes down the wire.</p> <p>The examples above are so small that gzip doesn't actually help. The original version is unchanged at 114 bytes while the hand-optimized one is actually larger after compression, growing from 91 to 113 bytes.</p></details></div></article><hr><div class=suggested-post-links><h3>Suggested reading</h3><a class=previous href=/posts/lithe-4> Previously: <b>Lithe 4: On the Shoulders of Giants</b> </a><a class=next href=/posts/lithe-6> Up next: <b>Lithe 6: What about WASM?</b> </a></div></main></div><footer class="app-footer fade-in"><p>© 2025  Michael Adams  <a href=/rss.xml target=_blank title=rss> <span class=inline-svg> <svg class="feather feather-rss" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </span> </a></footer></div>