<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Lithe 6: What about WASM?</title><meta content="Continued exploration of Lithe, an attempt at re-writing the Svelte compiler in Rust" name=description><link href="/style.css?h=113f377b3ae52303efd1" integrity="sha256-ET83ezrlIwPv0VEg5Um8fx4qGJsUhKwPaUTyshbShXA=" crossorigin rel=stylesheet><link href="/post.css?h=618e029f323073604e10" integrity="sha256-YY4CnzIwc2BOEGNHgWXNaGjZyO9H+TjljQ/oWRSHwEg=" crossorigin rel=stylesheet><script src="/js/post-scroll.js?h=edfc3a547fcea064d0ad" async crossorigin></script><body><header class="app-header slide-in-from-top"><nav><a href=/>About</a><a class=active href=/posts/>Posts</a><a href=/minis/>Minis</a><a href=/projects/>Projects</a></nav><div class=socials><a rel="noopener me" href=https://www.linkedin.com/in/loremdipso/ target=_blank title=Linkedin> <span class=inline-svg> <svg viewbox="0 0 448 512" class=icon fill=#44bddc height=1em stroke=currentColor stroke-width=0 width=1em xmlns=http://www.w3.org/2000/svg><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg> </span> </a><a rel="noopener me" href=https://github.com/loremdipso target=_blank title=Github> <span class=inline-svg> <svg viewbox="0 0 496 512" class=icon fill=#44bddc height=1em stroke=currentColor stroke-width=0 width=1em xmlns=http://www.w3.org/2000/svg><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg> </span> </a></div></header><div class=content-wrapper><div class=content><div class=progress-bar></div><main><article><header class=post-header><h1>Lithe 6: What about WASM?</h1><hr><div class=post-subheader><div class=post-metadata>Jan 13, 2022 · 3 minute read</div><div class=tags><a class=tag href=https://loremdipso.com/tags/devlog/> <span class=inline-svg> <svg class="feather feather-tag meta-icon" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1=7 x2=7 y1=7 y2=7></line></svg> </span> devlog </a><a class=tag href=https://loremdipso.com/tags/lithe/> <span class=inline-svg> <svg class="feather feather-tag meta-icon" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1=7 x2=7 y1=7 y2=7></line></svg> </span> lithe </a><a class=tag href=https://loremdipso.com/tags/svelte/> <span class=inline-svg> <svg class="feather feather-tag meta-icon" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1=7 x2=7 y1=7 y2=7></line></svg> </span> svelte </a></div></div><a href="https://github.com/loremdipso/loremdipso.github.io/issues/new?title=Issue with lithe-6&body=I found an issue on page 'Lithe 6: What about WASM?'" class=feedback target=#>Found a mistake? Let me know!</a></header><div class=post-contents><div class=sidenav><aside class=toc-wrapper><div class=toc-title>Contents</div><ul><li><a href=#excuses>Excuses</a><li><a href=#thinking-ahead>Thinking Ahead</a><li><a href=#an-aside>An Aside</a><li><a href=#what-s-wasm-again>What's WASM again?</a><li><a href=#how-to>How to</a><li><a href=#conclusion>Conclusion</a></ul></aside></div><h2 id=excuses><a aria-label="Anchor link for: excuses" class=zola-anchor href=#excuses>Excuses</a></h2><p>I know I haven't talked much about the state of Lithe except to mention how fast it is while run natively, but that's only because Lithe is still very very bare bones. It parses the contents of svelte files into an HTML AST, which it then transforms into a more Svelte-y AST, which it then runs through to generate the final output. And it only works for the simplest of svelte files.<h2 id=thinking-ahead><a aria-label="Anchor link for: thinking-ahead" class=zola-anchor href=#thinking-ahead>Thinking Ahead</a></h2><p>But before I write more about the internals of Lithe or implement any new features, I thought it'd be a fun diversion to think ahead to when this is a smash success and absolutely everyone wants it. How are we going to package and release it? The obvious (and my initial) answer was as a native extension that we talk to via FFI. But how will that be received? JavaScript developers like fast build times, even at the very start. Projects like <a rel="noopener nofollow noreferrer" href=https://www.snowpack.dev/ target=_blank>Snowpack</a> are successful exactly because of that. No frontend engineer wants to wait for the latest compiler to be downloaded and build on their local machine, especially if that requires the Rust toolchain.<h2 id=an-aside><a aria-label="Anchor link for: an-aside" class=zola-anchor href=#an-aside>An Aside</a></h2><p>I never knew, but apparently tsc is, itself, written in TypeScript. Which really calls into question this whole endeavor. If something as successful as tsc (which I never felt was all that slow) is written in TypeScript, why can't Svelte? The move to Rust has never been a sure one, and this might just be another reason against. Perhaps the performance limitations I'm trying to solve are more algorithmic than they are technical.<h2 id=what-s-wasm-again><a aria-label="Anchor link for: what-s-wasm-again" class=zola-anchor href=#what-s-wasm-again>What's WASM again?</a></h2><p>In any case, assuming Lithe is alive and well and we want to release it to impatient developers, we could maybe release native binaries. This seems (to me, anyway) to be something of a hassle, plus your consumers need to have the utmost trust in you. So what about <a rel="noopener nofollow noreferrer" href=https://webassembly.org/ target=_blank>WASM</a>? It's cross-platform, I assume Node can run it, and I can only imagine that it's cutoff from anything dangerous like network or file IO by default.<h2 id=how-to><a aria-label="Anchor link for: how-to" class=zola-anchor href=#how-to>How to</a></h2><p>I set to work slightly modifying Lithe to output a WASM module rather than a native Rust lib. There were only two non-obvious changes I had to make. First, I needed to set my WASM's <code>package.json</code>'s <code>type</code> to be <code>module</code> to get it to load correctly:<pre class=language-js data-lang=js style=color:#cccece;background-color:#2b2c2f><code class=language-js data-lang=js><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>name</span><span style=color:#5fb3b3>"</span><span>: </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>lithe</span><span style=color:#5fb3b3>",
</span><span>  </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>version</span><span style=color:#5fb3b3>"</span><span>: </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>0.1.0</span><span style=color:#5fb3b3>",
</span><span>  </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>files</span><span style=color:#5fb3b3>"</span><span>: [
</span><span>    </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>lithe_bg.wasm</span><span style=color:#5fb3b3>",
</span><span>    </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>lithe.js</span><span style=color:#5fb3b3>",
</span><span>    </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>lithe_bg.js</span><span style=color:#5fb3b3>",
</span><span>    </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>lithe.d.ts</span><span style=color:#5fb3b3>"
</span><span>  ]</span><span style=color:#5fb3b3>,
</span><span>  </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>module</span><span style=color:#5fb3b3>"</span><span>: </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>lithe.js</span><span style=color:#5fb3b3>",
</span><span>  </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>types</span><span style=color:#5fb3b3>"</span><span>: </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>lithe.d.ts</span><span style=color:#5fb3b3>",
</span><span>  </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>sideEffects</span><span style=color:#5fb3b3>"</span><span>: </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>,
</span><span>  </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>type</span><span style=color:#5fb3b3>"</span><span>: </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>module</span><span style=color:#5fb3b3>", </span><span style=color:#5f6364>// &lt;- new
</span><span style=color:#5fb3b3>}
</span></code></pre><p>I also had to refrain from using <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/time/index.html target=_blank><code>std::time</code></a>, though luckily I was only using that for detailed performance tracing. With those two small changes done it just... worked. I am now able to import my compiler with a wondrously simple:<pre class=language-ts data-lang=ts style=color:#cccece;background-color:#2b2c2f><code class=language-ts data-lang=ts><span style=color:#c594c5>import </span><span style=color:#5fb3b3>{ </span><span>wasm_compile </span><span style=color:#5fb3b3>} </span><span style=color:#c594c5>from </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>./wasm/lithe.js</span><span style=color:#5fb3b3>";
</span></code></pre><p>Wow. And the timings were better than I could have hoped: just <code>4ms</code> for 1000 <code>span</code>'s, which is just as fast as native!!!<p>I checked my enthusiasm, and then I checked the output to make sure it was actually doing what it should (it was). Then to make sure I was actually doing the timing correctly (I was) I tried 10,000 <code>span</code>'s, and that took only <code>42ms</code>. Svelte, for comparison, had long since overflowed its stack.<p>I should note that I don't actually think WASM is just as fast as native. Maybe it is in some instances, but the times involved here are so small and the testing itself so basic that I can't confidently prove anything. But what I can do is predict that, when all is said and done, that the WASM version of Lithe is probably going to run about as fast as the native version most of the time. But even if it's 20x slower that's still far faster than Svelte's TypeScript compiler and that's good enough for me.<h2 id=conclusion><a aria-label="Anchor link for: conclusion" class=zola-anchor href=#conclusion>Conclusion</a></h2><p>It might be too early to tell, but just from this it's looking like releasing this compiler via WASM might be totally viable. And the icing on the cake? The current version of Lithe, when compiled to WASM, weighs in at a mere <code>268K</code>. <code>268K</code>! That's even smaller than a native <a rel="noopener nofollow noreferrer" href=https://stackoverflow.com/questions/29008127/why-are-rust-executables-so-huge target=_blank>hello world in Rust</a>. Color me impressed.<details><summary>Disclaimer</summary> <p>I did have to enable node's <code>--experimental-wasm-modules</code> flag to get my WASM binary to even load. I'm hoping that flag goes away and WASM is supported by default, but I suppose there's a chance WASM goes the <a href=https://www.zdnet.com/article/flash-is-dead-long-live-html5/>way of flash</a>.</p></details></div></article><hr><div class=suggested-post-links><h3>Suggested reading</h3><a class=previous href=/posts/lithe-5> Previously: <b>Lithe 5: Optimize for the minifier</b> </a><a class=next href=/posts/lithe-7> Up next: <b>Lithe 7 - Apples to Apples</b> </a></div></main></div><footer class="app-footer fade-in"><p>© 2025  Michael Adams  <a href=/rss.xml target=_blank title=rss> <span class=inline-svg> <svg class="feather feather-rss" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </span> </a></footer></div>