<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Lithe 4: On the Shoulders of Giants</title><meta content="Continued exploration of Lithe, an attempt at re-writing the Svelte compiler in Rust" name=description><link href="/style.css?h=113f377b3ae52303efd1" integrity="sha256-ET83ezrlIwPv0VEg5Um8fx4qGJsUhKwPaUTyshbShXA=" crossorigin rel=stylesheet><link href="/post.css?h=618e029f323073604e10" integrity="sha256-YY4CnzIwc2BOEGNHgWXNaGjZyO9H+TjljQ/oWRSHwEg=" crossorigin rel=stylesheet><script src="/js/post-scroll.js?h=edfc3a547fcea064d0ad" async crossorigin></script><body><header class="app-header slide-in-from-top"><nav><a href=/>About</a><a class=active href=/posts/>Posts</a><a href=/minis/>Minis</a><a href=/projects/>Projects</a></nav><div class=socials><a rel="noopener me" href=https://www.linkedin.com/in/loremdipso/ target=_blank title=Linkedin> <span class=inline-svg> <svg viewbox="0 0 448 512" class=icon fill=#44bddc height=1em stroke=currentColor stroke-width=0 width=1em xmlns=http://www.w3.org/2000/svg><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg> </span> </a><a rel="noopener me" href=https://github.com/loremdipso target=_blank title=Github> <span class=inline-svg> <svg viewbox="0 0 496 512" class=icon fill=#44bddc height=1em stroke=currentColor stroke-width=0 width=1em xmlns=http://www.w3.org/2000/svg><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg> </span> </a></div></header><div class=content-wrapper><div class=content><div class=progress-bar></div><main><article><header class=post-header><h1>Lithe 4: On the Shoulders of Giants</h1><hr><div class=post-subheader><div class=post-metadata>Jan 03, 2022 · 3 minute read</div><div class=tags><a class=tag href=https://loremdipso.com/tags/devlog/> <span class=inline-svg> <svg class="feather feather-tag meta-icon" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1=7 x2=7 y1=7 y2=7></line></svg> </span> devlog </a><a class=tag href=https://loremdipso.com/tags/lithe/> <span class=inline-svg> <svg class="feather feather-tag meta-icon" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1=7 x2=7 y1=7 y2=7></line></svg> </span> lithe </a><a class=tag href=https://loremdipso.com/tags/performance/> <span class=inline-svg> <svg class="feather feather-tag meta-icon" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1=7 x2=7 y1=7 y2=7></line></svg> </span> performance </a><a class=tag href=https://loremdipso.com/tags/svelte/> <span class=inline-svg> <svg class="feather feather-tag meta-icon" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1=7 x2=7 y1=7 y2=7></line></svg> </span> svelte </a></div></div><a href="https://github.com/loremdipso/loremdipso.github.io/issues/new?title=Issue with lithe-4&body=I found an issue on page 'Lithe 4: On the Shoulders of Giants'" class=feedback target=#>Found a mistake? Let me know!</a></header><div class=post-contents><p>Starting from characters and parsing that into an AST that could render a Svelte program could definitely open open possibilities for some low-level optimizations, but even just parsing a normal HTML document is not a small project, and Svelte includes JavaScript, TypeScript, Handlebars-esque blocks, CSS, and SCSS, too. Doing all that at once would be the mother of all slogs. But, luckily, I don't have to! There exist many, many pre-build alternatives. The Svelte compiler itself even uses a couple.<p>So here's the new plan:<ol><li>Create a basic Rust lib and make sure I can get communication working to/from JavaScript via FFI in Node<li>Send a svelte file as a string through a DOM parser to get a basic AST<li>Convert that AST to our own custom one <ul><li>This is where we should do any conversions we might want to the original AST, like squashing child Text nodes, splitting nodes or inserting nodes, etc.</ul><li>Render that custom AST to a string <ul><li>We should eventually keep track of other things, warnings, CSS, etc., but for now we're simply trying to replicate the JavaScript string<li>We should keep in mind that whatever we do here we'll need to do something very similar when rendering for SSR, so we should do as much AST manipulation as possible before this step. This should be a simple "let's render a string"</ul></ol><p>But before we really get started let's see what kind of performance we're getting out of the original compiler. I'm only looking to test execution times, so to ignore however long it takes to load everything into Node's runtime we'll simply do two runs per test: once to ensure everything's loaded, and the other we'll actually time. How long does Svelte take to compile this simple program?<pre class=language-html data-lang=html style=color:#cccece;background-color:#2b2c2f><code class=language-html data-lang=html><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>></span><span>Hello world!</span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>>
</span></code></pre><p>On my machine this is about <code>5ms</code>. That seems... high? I think? I haven't written a compiler before, but computers are fast and this program is absolutely tiny. Maybe there's some cost to compile anything, regardless of program size? Let's see how it scales. What if we do 10x?<pre class=language-html data-lang=html style=color:#cccece;background-color:#2b2c2f><code class=language-html data-lang=html><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>></span><span>Hello world!</span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>>
</span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>></span><span>Hello world!</span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>>
</span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>></span><span>Hello world!</span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>>
</span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>></span><span>Hello world!</span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>>
</span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>></span><span>Hello world!</span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>>
</span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>></span><span>Hello world!</span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>>
</span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>></span><span>Hello world!</span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>>
</span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>></span><span>Hello world!</span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>>
</span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>></span><span>Hello world!</span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>>
</span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>></span><span>Hello world!</span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>span</span><span style=color:#5fb3b3>>
</span></code></pre><p>I should note this renders extra calls to a <code>space()</code> function by default (I assume so the resultant DOM looks nice), so to avoid this I remove all newlines during tests. Anyway, with newlines removed this takes <code>16ms</code>. Hmmm.... let's do a few more:<table><thead><tr><th>Number of <code>span</code>s<th>Time to render<tbody><tr><td>1<td>5ms<tr><td>10<td>16ms<tr><td>100<td>62ms<tr><td>1000<td>432ms</table><p>Okay, so half a second for 1000 elements isn't super great, but it's still probably okay. How often are you writing components this big anyhow? And any half-decent system would only recompile whenever you make changes. Still, fast compiles make for happy devs, so this is the mark we're trying to beat.<p>The only other order of business for now is the name. I did what I always do and looked up some synonyms for similar projects, in this case Svelte. After some browsing I landed on <code>lithe</code>, so that's what I'll use for now until I find some other JS project already picked that name.<details><summary>Click for spoilers</summary> <p>Lithe is far from done, but it can easily render the example programs above. In release mode, 1000 <code>span</code>s takes just <code>5ms</code> to run (!!!), most of which is simply the initial DOM parsing provided by an external library. Time is lost initializing FFI and shuttling strings to/from Node, but even so it turns out Rust is really really fast (who knew?). As we add more features lithe can only slow down, but for now I'll take this as a sign that this work might actually be useful.</p></details></div></article><hr><div class=suggested-post-links><h3>Suggested reading</h3><a class=previous href=/posts/lithe-3> Previously: <b>Lithe 3: A Rewrite</b> </a><a class=next href=/posts/lithe-5> Up next: <b>Lithe 5: Optimize for the minifier</b> </a></div></main></div><footer class="app-footer fade-in"><p>© 2025  Michael Adams  <a href=/rss.xml target=_blank title=rss> <span class=inline-svg> <svg class="feather feather-rss" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </span> </a></footer></div>